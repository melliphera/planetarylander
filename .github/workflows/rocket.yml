name: Rocket (MISRA-Rust) CI

on:
  push:
    paths:
      - 'rocket/**'
      - '.github/workflows/rocket.yml'
  pull_request:
    paths:
      - 'rocket/**'

jobs:
  misra-compliance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      
      - name: Install coverage tools
        run: cargo install cargo-llvm-cov
      
      - name: Check MISRA-Rust lints
        run: cargo clippy --package agc-rocket -- -D warnings
      
      - name: Run tests with coverage
        run: |
          cargo llvm-cov --package agc-rocket \
            --lcov --output-path lcov.info \
            --ignore-filename-regex "tests/"
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: lcov.info
          flags: rocket
          fail_ci_if_error: true
      
      - name: Check documentation
        run: cargo doc --package agc-rocket --no-deps --document-private-items
      
      - name: Verify no panics in release
        run: |
          cargo build --package agc-rocket --release
          ! grep -r "panic\|unwrap\|expect" rocket/src --include="*.rs" || exit 1